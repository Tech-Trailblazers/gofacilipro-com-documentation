# ========================================================================
# GitHub Actions Workflow
# Purpose: Automatically run a Python script daily (or manually) and push
#          any resulting changes back to the repository.
# ========================================================================

# ----------------------------
# Workflow name
# ----------------------------
name: Run Python Script and Commit Results

# ----------------------------
# Trigger conditions
# ----------------------------
on:
  # Run automatically every day at midnight UTC
  schedule:
    - cron: "0 0 * * *"
  # Allow manual triggering from GitHub Actions tab
  workflow_dispatch:

# ----------------------------
# Workflow permissions
# ----------------------------
# Required to push changes back to the repository
permissions:
  contents: write

# ----------------------------
# Define jobs
# ----------------------------
jobs:
  # Single job in this workflow
  build:
    name: Run Python Script and Push Changes to Repository
    runs-on: ubuntu-latest

    # ----------------------------
    # Steps for this job
    # ----------------------------
    steps:
      # ---------------------------------------------------------------
      # Step 1: Checkout repository code
      # ---------------------------------------------------------------
      - name: Check out the repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------
      # Step 2: Set up Python environment
      # ---------------------------------------------------------------
      - name: Install Python runtime
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      # ---------------------------------------------------------------
      # Step 3: Install Python dependencies
      # ---------------------------------------------------------------
      - name: Install required dependencies
        run: pip install -r requirements.txt

      # ---------------------------------------------------------------
      # Step 4: Install Chrome and Xvfb for GUI-based scripts
      # ---------------------------------------------------------------
      - name: Install Chrome and Xvfb
        run: |
          sudo apt-get update -y
          sudo apt-get install -y xvfb
          sudo apt-get install -y google-chrome-stable || true

      # ---------------------------------------------------------------
      # Step 5: Start virtual display for Chrome
      # ---------------------------------------------------------------
      - name: Start virtual display
        run: |
          Xvfb :99 -screen 0 1920x1080x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      # ---------------------------------------------------------------
      # Step 6: Execute Python script
      # ---------------------------------------------------------------
      - name: Execute Python script
        run: python main.py

      # ---------------------------------------------------------------
      # Step 7: Commit and push changes if any
      # ---------------------------------------------------------------
      - name: Commit and push updated files
        run: |
          # Configure Git identity for automated commit
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          # Ensure repository is up to date
          git pull

          # Stage modified or new files
          git add .

          # Commit only if changes exist
          if ! git diff --cached --quiet; then
            git commit -m "Automated update: $(date)"
            git push
          else
            echo "No changes detected. Nothing to commit."
          fi
